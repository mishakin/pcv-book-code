<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
                "http://www.w3.org/TR/REC-html40/loose.dtd">
<html>
<head>
  <title>Description of estimate_dem_robust</title>
  <meta name="keywords" content="estimate_dem_robust">
  <meta name="description" content="% robustly estimate correction to dem">
  <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
  <meta name="generator" content="m2html v1.5 &copy; 2003-2005 Guillaume Flandin">
  <meta name="robots" content="index, follow">
  <link type="text/css" rel="stylesheet" href="../../../m2html.css">
</head>
<body>
<a name="_top"></a>
<div><a href="../../../Documentation.html">Home</a> &gt;  <a href="#">16-Surface-Reconstruction</a> &gt; <a href="../Documentation.html">Surface-Reconstruction</a> &gt; <a href="Documentation.html">Functions</a> &gt; estimate_dem_robust.m</div>

<!--<table width="100%"><tr><td align="left"><a href="../../../Documentation.html"><img alt="<" border="0" src="../../../left.png">&nbsp;Master index</a></td>
<td align="right"><a href="Documentation.html">Index for 16-Surface-Reconstruction\Surface-Reconstruction\Functions&nbsp;<img alt=">" border="0" src="../../../right.png"></a></td></tr></table>-->

<h1>estimate_dem_robust
</h1>

<h2><a name="_name"></a>PURPOSE <a href="#_top"><img alt="^" border="0" src="../../../up.png"></a></h2>
<div class="box"><strong>% robustly estimate correction to dem</strong></div>

<h2><a name="_synopsis"></a>SYNOPSIS <a href="#_top"><img alt="^" border="0" src="../../../up.png"></a></h2>
<div class="box"><strong>function [A,weights,dx,v,W,Nmatrix]=estimate_dem_robust(N,U,Np,Nr,Mc,poi,xa,weights,sigma_k,iter,iter_switch,type_robust,L1,out_in,print_type,plot_type); </strong></div>

<h2><a name="_description"></a>DESCRIPTION <a href="#_top"><img alt="^" border="0" src="../../../up.png"></a></h2>
<div class="fragment"><pre class="comment">% robustly estimate correction to dem

 Optimization function using curvature for regularization
   energy = sum_m rho(l_m-a_m)/sigma_n) + 
             1/sigma_d sum_ij d_ii^2+2d_ij^2+djj^2
 l_m = observed heights, interpolated bilinearly
 a_m unknown grid heights, d_ij second derivatives

 [A,weights,dx,v,W,Nmatrix]=...
   estimate_dem_robust...
    (N,U,Np,Nr,Mc,poi,xa,weights,sigma_k,iter,iter_switch,type_robust,L1,...
    out_in,print_type,plot_type)

 N           = number of observations (points+second derivatives)
 U           = number of unknowns (dem)
 Np          = number of points
 Nr          = number of rows
 Mc          = number oc columns 
 poi         = Npx4 matrix of points (x,y,h,sigma), x,y, referring to grid
 xa          = approximate values for dem
 weights     = Nx1 vector of weights in [0,1]
 sigma_k     = standard deviation of second derivatives
 iter        = current iteration for controling weighting
 iter_switch = iteration number where to switch type of weighting
 type_robust = 0,1,2,3, (00,01,10,11) for points and dem
 L1          = 0/1 choice of weight function (0 = exponential, 1 = L1)
 out_in      = boolean Np-vector indicating inliers
 print_type  = 0,1,2
 plot_type   = 0,1,2

 A         = NxU sparse design matrix
 weights   = new weights
 dx        = delta dem
 v         = normalized residuals
 W         = weigths of obs. combining uncertainty and robust factor
 Nmatrix   = normal equation matrix

 wf 7/2014, 2/2018</pre></div>

<!-- crossreference -->
<h2><a name="_cross"></a>CROSS-REFERENCE INFORMATION <a href="#_top"><img alt="^" border="0" src="../../../up.png"></a></h2>
This function calls:
<ul style="list-style-image:url(../../../matlabicon.gif)">
</ul>
This function is called by:
<ul style="list-style-image:url(../../../matlabicon.gif)">
</ul>
<!-- crossreference -->



<h2><a name="_source"></a>SOURCE CODE <a href="#_top"><img alt="^" border="0" src="../../../up.png"></a></h2>
<div class="fragment"><pre>0001 <span class="comment">%% robustly estimate correction to dem</span>
0002 <span class="comment">%</span>
0003 <span class="comment">% Optimization function using curvature for regularization</span>
0004 <span class="comment">%   energy = sum_m rho(l_m-a_m)/sigma_n) +</span>
0005 <span class="comment">%             1/sigma_d sum_ij d_ii^2+2d_ij^2+djj^2</span>
0006 <span class="comment">% l_m = observed heights, interpolated bilinearly</span>
0007 <span class="comment">% a_m unknown grid heights, d_ij second derivatives</span>
0008 <span class="comment">%</span>
0009 <span class="comment">% [A,weights,dx,v,W,Nmatrix]=...</span>
0010 <span class="comment">%   estimate_dem_robust...</span>
0011 <span class="comment">%    (N,U,Np,Nr,Mc,poi,xa,weights,sigma_k,iter,iter_switch,type_robust,L1,...</span>
0012 <span class="comment">%    out_in,print_type,plot_type)</span>
0013 <span class="comment">%</span>
0014 <span class="comment">% N           = number of observations (points+second derivatives)</span>
0015 <span class="comment">% U           = number of unknowns (dem)</span>
0016 <span class="comment">% Np          = number of points</span>
0017 <span class="comment">% Nr          = number of rows</span>
0018 <span class="comment">% Mc          = number oc columns</span>
0019 <span class="comment">% poi         = Npx4 matrix of points (x,y,h,sigma), x,y, referring to grid</span>
0020 <span class="comment">% xa          = approximate values for dem</span>
0021 <span class="comment">% weights     = Nx1 vector of weights in [0,1]</span>
0022 <span class="comment">% sigma_k     = standard deviation of second derivatives</span>
0023 <span class="comment">% iter        = current iteration for controling weighting</span>
0024 <span class="comment">% iter_switch = iteration number where to switch type of weighting</span>
0025 <span class="comment">% type_robust = 0,1,2,3, (00,01,10,11) for points and dem</span>
0026 <span class="comment">% L1          = 0/1 choice of weight function (0 = exponential, 1 = L1)</span>
0027 <span class="comment">% out_in      = boolean Np-vector indicating inliers</span>
0028 <span class="comment">% print_type  = 0,1,2</span>
0029 <span class="comment">% plot_type   = 0,1,2</span>
0030 <span class="comment">%</span>
0031 <span class="comment">% A         = NxU sparse design matrix</span>
0032 <span class="comment">% weights   = new weights</span>
0033 <span class="comment">% dx        = delta dem</span>
0034 <span class="comment">% v         = normalized residuals</span>
0035 <span class="comment">% W         = weigths of obs. combining uncertainty and robust factor</span>
0036 <span class="comment">% Nmatrix   = normal equation matrix</span>
0037 <span class="comment">%</span>
0038 <span class="comment">% wf 7/2014, 2/2018</span>
0039 <span class="comment">%</span>
0040 
0041 <a name="_sub0" href="#_subfunctions" class="code">function [A,weights,dx,v,W,Nmatrix]=</a><span class="keyword">...</span>
0042     estimate_dem_robust<span class="keyword">...</span>
0043     (N,U,Np,Nr,Mc,poi,xa,weights,sigma_k,iter,iter_switch,type_robust,L1,<span class="keyword">...</span>
0044     out_in,print_type,plot_type);
0045     
0046 typec=1;
0047 
0048 <span class="comment">%% factor for update weights indicating outliers</span>
0049 k= 2;
0050 
0051 <span class="comment">%% start estimation</span>
0052 <span class="comment">% initiate size of A</span>
0053             <span class="keyword">if</span> print_type &gt; 0
0054                 start_time_sol = cputime;
0055             <span class="keyword">end</span>
0056 A = spalloc(N,U,6*N);
0057 b = zeros(N,1); 
0058 W = spalloc(N,N,N);
0059 Ac = spalloc(N,U,6*N);
0060 bc = zeros(N,1); 
0061 Wc = spalloc(N,N,N);
0062 
0063         <span class="comment">% observations, normalized with 1/sqrt of variances</span>
0064         tic
0065         <span class="keyword">for</span> p = 1:Np
0066             x = poi(p,1);
0067             y = poi(p,2);
0068             w = 1/poi(p,4)*sqrt(weights(p))*out_in(p);
0069             i = floor(x);
0070             j = floor(y);
0071             aa = x-i;
0072             bb = y-j;
0073             maa = 1-aa;
0074             mbb=  1-bb;
0075             g1=maa*mbb;
0076             g2=aa*mbb;
0077             g3=maa*bb;
0078             g4=aa*bb;
0079 <span class="comment">%             %delta_x</span>
0080 <span class="comment">%             A(p,i+j*Nr+1)       = (1-aa)*(1-bb)*w;</span>
0081 <span class="comment">%             A(p,i+j*Nr+2)       =    aa *(1-bb)*w;</span>
0082 <span class="comment">%</span>
0083 <span class="comment">%             A(p,i+(j+1)*Nr+1)   = (1-aa)* bb   *w;</span>
0084 <span class="comment">%             A(p,i+(j+1)*Nr+2)   =    aa * bb   *w;</span>
0085 <span class="comment">%             delta_l =  poi(p,3) - ...</span>
0086 <span class="comment">%                 ((1-aa)*(1-bb)*xa(i+j*Nr+1)    +...</span>
0087 <span class="comment">%                 aa *(1-bb)*xa(i+j*Nr+2)    +...</span>
0088 <span class="comment">%                 (1-aa)* bb   *xa(i+(j+1)*Nr+1)+...</span>
0089 <span class="comment">%                 aa * bb   *xa(i+(j+1)*Nr+2));</span>
0090             A(p,i+j*Nr+1)       = g1*w;
0091             A(p,i+j*Nr+2)       = g2*w;
0092             A(p,i+(j+1)*Nr+1)   = g3*w;
0093             A(p,i+(j+1)*Nr+2)   = g4*w;
0094             delta_l =  poi(p,3) - <span class="keyword">...</span>
0095                 (g1*xa(i+j*Nr+1)    +<span class="keyword">...</span>
0096                  g2*xa(i+j*Nr+2)    +<span class="keyword">...</span>
0097                  g3*xa(i+(j+1)*Nr+1)+<span class="keyword">...</span>
0098                  g4*xa(i+(j+1)*Nr+2));
0099             b(p)                =   delta_l * w;
0100             W(p,p)=w;
0101         <span class="keyword">end</span>
0102         
0103         time_for_A_points=toc
0104 
0105 
0106             <span class="keyword">if</span> print_type &gt; 0
0107                 time_for_building_An=toc
0108             <span class="keyword">end</span>
0109 
0110 <span class="comment">%% priors</span>
0111 tic
0112 Icc = Np;                    <span class="comment">% first index for column curvatures</span>
0113 Irr = Np + (Nr-2)*Mc;        <span class="comment">% first index for row curvature</span>
0114 Irc = Np + (Nr-2)*Mc + Nr*(Mc-2);    <span class="comment">% first index for torsion</span>
0115 <span class="comment">% coefficients for column curvature</span>
0116         <span class="comment">% cc  1</span>
0117         <span class="comment">%    -2</span>
0118         <span class="comment">%     1</span>
0119 Jcc = [-1,0,+1];  <span class="comment">% index vector</span>
0120 Vcc = [ 1 -2 1];                    <span class="comment">% coefficients</span>
0121 wcc = 1/sigma_k;<span class="comment">%/sqrt(6);  % /norm(Vcc)</span>
0122 <span class="comment">% coefficients for row curvature</span>
0123         <span class="comment">% rr  1 -2  1</span>
0124 Jrr = [-Nr,0,+Nr];  <span class="comment">% index vector</span>
0125 Vrr = [1 -2  1];                    <span class="comment">% coefficients</span>
0126 wrr = 1/sigma_k;<span class="comment">% /sqrt(6); % /norm(Vrr)</span>
0127 <span class="comment">% coefficients for torsion</span>
0128         <span class="comment">% rc  1  -1</span>
0129         <span class="comment">%    -1   1</span>
0130 <span class="comment">%                  ^</span>
0131 Jrc = [-Nr-1,-Nr,-1,0];      <span class="comment">% indices</span>
0132 Vrc = [1 -1 -1 1];                <span class="comment">% coefficients</span>
0133 <span class="comment">%wrc = 1/sigma_k*2;  %/sqrt(2); %/2; % /norm(Vrc)</span>
0134 wrc = 1/sigma_k/sqrt(2);      <span class="comment">% quadratic variation</span>
0135 <span class="comment">% built up of priors in A</span>
0136 <span class="comment">% column curvature</span>
0137 <span class="keyword">for</span> j=1:Mc
0138     <span class="keyword">for</span> i=2:Nr-1
0139         IU  = i+(j-1)*Nr;
0140         <span class="comment">%[i,j,IU]</span>
0141         Icc = Icc+1;
0142         A(Icc,IU+Jcc) = Vcc * wcc * sqrt(weights(Icc));
0143         delta_cc      = 0-xa(IU+Jcc)' * Vcc';
0144         b(Icc)        = delta_cc * wcc * sqrt(weights(Icc));
0145         W(Icc,Icc)    = wcc * sqrt(weights(Icc));
0146     <span class="keyword">end</span>
0147 <span class="keyword">end</span>
0148 
0149 <span class="comment">% row curvature</span>
0150 <span class="keyword">for</span> j=2:Mc-1
0151     <span class="keyword">for</span> i=1:Nr
0152         IU  = i+(j-1)*Nr;
0153         <span class="comment">%[i,j,IU]</span>
0154         Irr = Irr+1;
0155         A(Irr,IU+Jrr) = Vrr * wrr * sqrt(weights(Irr));
0156         delta_rr      = 0-xa(IU+Jrr)' * Vrr';
0157         b(Irr)        = delta_rr * wrr * sqrt(weights(Irr));
0158         W(Irr,Irr)    = wrr * sqrt(weights(Irr));
0159     <span class="keyword">end</span>
0160 <span class="keyword">end</span>
0161 
0162 
0163 
0164 <span class="comment">% torsion</span>
0165 <span class="keyword">for</span> j=2:Mc
0166     <span class="keyword">for</span> i=2:Nr
0167         IU  = i+(j-1)*Nr;
0168         <span class="comment">%[i,j,IU]</span>
0169         Irc = Irc+1;
0170         A(Irc,IU+Jrc) = Vrc * wrc * sqrt(weights(Irc));
0171         delta_rc      = 0-xa(IU+Jrc)' * Vrc';
0172         b(Irc)        = delta_rc * wrc * sqrt(weights(Irc));
0173         W(Irc,Irc)    = wrc * sqrt(weights(Irc));
0174     <span class="keyword">end</span>
0175 <span class="keyword">end</span>
0176 time_for_A_prior=toc
0177 <span class="comment">%</span>
0178             <span class="keyword">if</span> print_type &gt; 1
0179                 <span class="keyword">if</span> U &lt; 1000
0180                     Ab = 2*[full(A)]
0181                     null_A_prior = U-rank(full(A(U+1:<span class="keyword">end</span>,:)));
0182                     rankA = rank(full(A(U+1:<span class="keyword">end</span>,:)));
0183                 <span class="keyword">end</span>
0184 
0185 
0186             <span class="keyword">end</span>
0187 <span class="comment">%time_for_building_Ae=toc</span>
0188 <span class="comment">%% solve</span>
0189 
0190 <span class="comment">% sort</span>
0191 tic
0192 Nmatrix  = A'*A;
0193 
0194 
0195             <span class="keyword">if</span> iter==1 &amp;&amp; plot_type &gt; 1
0196                 size_N_matrix = size(Nmatrix);
0197                 non_zeros_N_matrix =nnz(Nmatrix);
0198                 figure
0199                 subplot(1,3,1)
0200                 spy(Nmatrix)
0201                 title(<span class="string">'N'</span>)
0202             <span class="keyword">end</span>
0203 
0204 permx    = symamd(Nmatrix);
0205 Aperm    = A(:,permx);
0206 
0207 
0208 
0209 
0210             <span class="keyword">if</span> iter==1 &amp;&amp; plot_type &gt; 1
0211                 subplot(1,3,2)
0212                 spy(Aperm'*Aperm)
0213                 title(<span class="string">'N, sorted'</span>)
0214             <span class="keyword">end</span>
0215 
0216 
0217 [C,R]      = qr(Aperm,b,0);
0218 
0219 dxperm   = R\C;
0220 Pm       = speye(U);
0221 Pm       = Pm(:,permx);
0222 dx       = Pm*dxperm;
0223 
0224 
0225 
0226                 time_for_QR_sorted=toc
0227 
0228             <span class="keyword">if</span> iter==1 &amp;&amp; plot_type &gt; 1
0229                 subplot(1,3,3)
0230                 spy(R)
0231                 fill_in = nnz(R)-(nnz(Nmatrix)/2+U/2)
0232                 percentage_nnz   = nnz(R)/(U*(U+1)/2)
0233                 relative_fill_in = fill_in/(nnz(Nmatrix)/2+U/2)
0234                 title(strcat(<span class="string">'reduced N sorted, fill in ='</span>,num2str(fill_in)))
0235             <span class="keyword">end</span>
0236 
0237 
0238             <span class="keyword">if</span> iter==1 &amp;&amp; plot_type &gt; 1
0239                 figure
0240                 subplot(1,2,1)
0241                 spy(A)
0242                 title(<span class="string">'A'</span>)
0243                 subplot(1,2,2)
0244                 spy(Aperm)
0245                 title(<span class="string">'A sorted'</span>)
0246             <span class="keyword">end</span>
0247 
0248 dx_sorted = dx;
0249 
0250             <span class="keyword">if</span> U &lt; 1600 &amp;&amp; plot_type &gt; 0
0251                 Aqt = R\Aperm';
0252                 figure
0253                 spy(Aqt')
0254                 title(<span class="string">'R\A sorted'</span>)
0255             <span class="keyword">end</span>
0256 
0257             <span class="keyword">if</span> print_type &gt; 0
0258                 time_for_solution=cputime-start_time_sol
0259             <span class="keyword">end</span>
0260 
0261 <span class="comment">% residuals (normalized)</span>
0262 v = A*dx-b;
0263 
0264 
0265 
0266 <span class="comment">% estimated variance factor</span>
0267 eso = norm(v)/sqrt(N-U);
0268 
0269 <span class="keyword">if</span> type_robust &gt; 0
0270     
0271     
0272     <span class="comment">% original non-normalized residuals</span>
0273     vori  = v;
0274     vori(1:Np)     = (v(1:Np).*poi(1:Np,4)./sqrt(weights(1:Np)));
0275     vori(Np+1,end) = (v(Np+1,end)*sigma_k./sqrt(weights(Np+1,end)));
0276     vs=vori;
0277     <span class="comment">%vs=v;</span>
0278         
0279     <span class="comment">% sigma_0 for points</span>
0280     eso_p = median(abs(v(1:Np)))*1.48;
0281     <span class="comment">%es_p  = median(abs(vs(1:Np)))*1.48;</span>
0282     
0283     <span class="comment">% sigma_0 for curvatures</span>
0284     eso_k = median(abs(v(Np+1:end)))*1.48;
0285     <span class="comment">%es_k  = median(abs(vs(Np+1:end)))*1.48;</span>
0286                 <span class="keyword">if</span> print_type &gt; 0
0287                     est_s0_s0p_s0k=[eso,eso_p,eso_k]
0288                 <span class="keyword">end</span>
0289 
0290     check_AtV_null=norm((A'*v));
0291     max_v_points = max(abs(v(1:Np)));
0292     max_v_curvat = max(abs(vs(Np+1,end)));
0293 
0294     <span class="comment">% critical values</span>
0295     kp = k*eso_p;
0296     kk = k*eso_k;
0297 <span class="comment">%     kp = k*es_p;</span>
0298 <span class="comment">%     kk = k*es_k;</span>
0299    
0300     <span class="comment">%kp = k;</span>
0301     
0302     
0303                 <span class="keyword">if</span> print_type &gt; 0
0304                     criticalvalue_kp_sigmap_kk_sigma_k=[kp,poi(1,4),kk,sigma_k]
0305                 <span class="keyword">end</span>
0306 <span class="keyword">end</span>
0307 
0308 <span class="keyword">if</span> iter == 1 &amp;&amp; type_robust &gt; 0 
0309     weights=ones(N,1);
0310 <span class="keyword">else</span>
0311     <span class="keyword">if</span> type_robust &gt; 0 &amp;&amp; L1
0312         <span class="comment">% dem</span>
0313         <span class="keyword">if</span> type_robust == 1 || (type_robust == 3 &amp;&amp; iter &gt; 2*iter_switch)
0314             <span class="comment">%weights(Np+1:end) = min(1,1./(abs(vs(Np+1:end))/kk+eps));</span>
0315             weights(Np+1:end) = min(1,1./(abs(v(Np+1:end))/kk+eps));
0316         <span class="keyword">end</span>
0317         <span class="comment">% points</span>
0318         <span class="keyword">if</span> type_robust == 2 || (type_robust ==3 &amp;&amp; iter &lt;= iter_switch)
0319             weights(1:Np) = min(1,1./(abs(v(1:Np))/kp+eps)).*out_in(1:Np);
0320         <span class="keyword">end</span>
0321     <span class="keyword">else</span>
0322         <span class="keyword">if</span> type_robust == 1 || (type_robust == 3 &amp;&amp; iter &gt; 2*iter_switch)
0323             <span class="comment">%weights(Np+1:end) = exp(-abs(vs(Np+1:end)).^2/kk^2/2)+0.0001;</span>
0324             weights(Np+1:end) = exp(-abs(v(Np+1:end)).^2/kk^2/2)+0.0001;
0325             <span class="comment">%weights(Np+1:end) = exp(-abs(vs(Np+1:end))./kk+0.0001);</span>
0326         <span class="keyword">end</span>
0327         <span class="keyword">if</span> type_robust == 2 || (type_robust ==3 &amp;&amp; iter &lt;= iter_switch)          
0328             weights(1:Np) = (exp(-abs(v(1:Np)).^2/kp^2/2)+0.0001).*out_in(1:Np);
0329         <span class="keyword">end</span>
0330     <span class="keyword">end</span>
0331 <span class="keyword">end</span>
0332 <span class="comment">%iter=iter</span>
0333 abs_dx = norm(dx);
0334 min_w_p=min(weights(1:Np));
0335 min_w_c=min(weights(Np+1:end));
0336 
0337             <span class="keyword">if</span> print_type &gt; 1
0338                full(inv(W)*A)
0339             <span class="keyword">end</span>
0340 
0341 <span class="keyword">return</span></pre></div>
<hr><address>Generated on Sat 21-Jul-2018 20:56:10 by <strong><a href="http://www.artefact.tk/software/matlab/m2html/" title="Matlab Documentation in HTML">m2html</a></strong> &copy; 2005</address>
</body>
</html>